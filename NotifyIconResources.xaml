<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:tb="http://www.hardcodet.net/taskbar"
    xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:local="clr-namespace:ScreenDimmer"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors">

    <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

    <ContextMenu x:Key="SysTrayMenu"
               ItemsSource="{Binding MenuItems}">
        <ContextMenu.ItemTemplate>
            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                    <!-- Fix: Use a MultiBinding with a Converter if you need to bind Visibility to IsSubMenu -->
                    <TextBlock Text="{Binding Header}" 
                               Visibility="{Binding IsSubMenu, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    <Button Content="{Binding Header}" Command="{Binding Command}" Visibility="{Binding IsExitbutton, Converter={StaticResource BoolToVisibilityConverter}}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                </StackPanel>
                <HierarchicalDataTemplate.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Vertical" Margin="8" Visibility="{Binding IsSubMenu, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Slider
                                Width="150"
                                Minimum="0"
                                Maximum="100"
                                TickFrequency="1"
                                SmallChange="1"
                                IsSnapToTickEnabled="True"
                                Value="{Binding Brightness, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <i:Interaction.Behaviors>
                                    <local:MouseWheelSliderBehavior Amount="1" />
                                </i:Interaction.Behaviors>
                            </Slider>
                            <Label Content="{Binding Brightness, StringFormat='Brightness: {0:F0}'}"
                                    HorizontalAlignment="Center"/>
                        </StackPanel>
                    </DataTemplate>
                </HierarchicalDataTemplate.ItemTemplate>
            </HierarchicalDataTemplate>
        </ContextMenu.ItemTemplate>
    </ContextMenu>

    <tb:TaskbarIcon
        x:Key="NotifyIcon"
        IconSource="/icons8-lichtdimmer-96.ico"
        ToolTipText="Left-click to show window, right-click for menu"
        NoLeftClickDelay="True"
        ContextMenu="{StaticResource SysTrayMenu}">
        <tb:TaskbarIcon.DataContext>
            <local:NotifyIconViewModel />
        </tb:TaskbarIcon.DataContext>
    </tb:TaskbarIcon>
</ResourceDictionary>
